# Nginx configuration for React SPA with API proxy
server {
    # Listen on port 80 (HTTP)
    listen 80;

    # Server name (use _ for default/catch-all)
    server_name _;

    # Root directory where static files are located
    root /usr/share/nginx/html;

    # Default file to serve
    index index.html;

    # ============================================
    # API PROXY CONFIGURATION
    # ============================================
    # Proxy all requests starting with /api to the backend service
    # This avoids CORS issues by making the frontend and backend
    # appear to be on the same domain
    location /api {
        # Backend service name from docker-compose (backend:8080)
        proxy_pass http://backend:8080;

        # Forward the original host header
        proxy_set_header Host $host;

        # Forward the real client IP
        proxy_set_header X-Real-IP $remote_addr;

        # Forward the proxy chain
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Forward the protocol (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # REACT ROUTER CONFIGURATION
    # ============================================
    # Handle all other requests (React app routes)
    location / {
        # Try to serve the file directly, otherwise serve index.html
        # This fixes the 404 error when refreshing React Router pages
        try_files $uri $uri/ /index.html;

        # Add caching headers for static assets
        # Cache for 1 hour
        add_header Cache-Control "public, max-age=3600";
    }

    # ============================================
    # STATIC ASSET CACHING
    # ============================================
    # Cache JavaScript and CSS files for longer (1 year)
    # These files have hashed names and change when content changes
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Disable logging for favicon requests to reduce noise
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
}
